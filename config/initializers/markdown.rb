# https://www.lugolabs.com/articles/render-markdown-views-with-redcarpet-and-pygment-in-rails
class MarkdownHandler
  def call(template, source)
    compiled_template = erb.call(template, source)
    "MarkdownHandler.markdown(begin;#{compiled_template};end)"
  end

  def self.markdown(text)
    key = cache_key(text)
    Rails.cache.fetch key do
      add_anchors(render(text))
    end
  end

  private

  def erb
    @erb ||= ActionView::Template.registered_template_handler(:erb)
  end

  def self.cache_key(text)
    Digest::MD5.hexdigest("#{text}v4")
  end

  def self.render(text)
    CommonMarker.render_doc(text, :UNSAFE).to_html(:UNSAFE)
  end

  # Rather than add a pipeline / library just for header anchors, we steal from html-pipeline
  # https://github.com/jch/html-pipeline/blob/master/lib/html/pipeline/toc_filter.rb
  def self.add_anchors(html)
    doc = Nokogiri::HTML.fragment(html)
    doc.css('h1, h2, h3, h4, h5, h6').each do |node|
      text = node.text
      id = ActiveSupport::Inflector.parameterize(text)
      if header_content = node.children.first
        header_content.add_previous_sibling(%(<a id="#{id}" class="anchor" href="##{id}" aria-hidden="true"><svg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'>
        <path d='M9.67848 13.8743C9.91634 14.1126 10.1834 14.3198 10.4733 14.4909L11.9851 12.9787C11.6462 12.889 11.3373 12.7109 11.0897 12.4627L10.9612 12.3344C10.7759 12.1491 10.6289 11.929 10.5286 11.6867C10.4283 11.4445 10.3767 11.1849 10.3767 10.9227C10.3767 10.6605 10.4283 10.4008 10.5286 10.1586C10.6289 9.91638 10.7759 9.69628 10.9612 9.51088L14.4888 5.98184C14.8633 5.60792 15.3708 5.39793 15.8999 5.39793C16.429 5.39793 16.9365 5.60792 17.311 5.98184L17.4394 6.1101C17.6247 6.2955 17.7717 6.5156 17.872 6.75783C17.9723 7.00007 18.0239 7.2597 18.0239 7.52189C18.0239 7.78408 17.9723 8.04371 17.872 8.28594C17.7717 8.52818 17.6247 8.74828 17.4394 8.93367L16.3114 10.0615C16.539 10.6424 16.6555 11.2609 16.655 11.8849C16.6548 12.1211 16.638 12.3571 16.6047 12.591L18.8506 10.3453C19.599 9.59644 20.0195 8.58085 20.0195 7.52189C20.0195 6.46292 19.599 5.44733 18.8506 4.69853L18.7221 4.57005C17.9737 3.82125 16.9585 3.40057 15.9 3.40057C14.8415 3.40057 13.8263 3.82125 13.0778 4.57005L9.55027 8.0993C8.80179 8.84811 8.3813 9.8637 8.3813 10.9227C8.3813 11.9816 8.80179 12.9972 9.55027 13.746L9.67848 13.8743ZM5.14887 19.3032L5.27729 19.4317C6.02635 20.1794 7.0413 20.5994 8.09945 20.5994C9.15761 20.5994 10.1726 20.1794 10.9216 19.4317L14.4492 15.9025C14.8198 15.5317 15.1138 15.0916 15.3145 14.6071C15.5151 14.1227 15.6183 13.6035 15.6183 13.0791C15.6183 12.5547 15.5151 12.0355 15.3145 11.5511C15.1138 11.0666 14.8198 10.6265 14.4492 10.2557L14.321 10.1275C14.0831 9.88919 13.816 9.68201 13.5261 9.51087L12.0144 11.023C12.3532 11.1129 12.6622 11.291 12.91 11.5391L13.0382 11.6675C13.2235 11.8529 13.3705 12.073 13.4708 12.3152C13.5711 12.5574 13.6227 12.817 13.6227 13.0792C13.6227 13.3414 13.5711 13.601 13.4708 13.8432C13.3705 14.0854 13.2235 14.3055 13.0382 14.4909L9.51064 18.0201C9.13608 18.394 8.62862 18.6039 8.09956 18.6039C7.5705 18.6039 7.06304 18.394 6.68848 18.0201L6.56006 17.8917C6.18634 17.5169 5.97646 17.0092 5.97646 16.4799C5.97646 15.9505 6.18634 15.4428 6.56006 15.0681L7.68737 13.9403C7.45981 13.3594 7.34327 12.7408 7.34379 12.1169C7.34402 11.8808 7.36067 11.645 7.39365 11.4112L5.14887 13.6565C4.40039 14.4053 3.9799 15.4209 3.9799 16.4799C3.9799 17.5388 4.40039 18.5544 5.14887 19.3032Z' fill='#B7BBBB'/>
        </svg>
        </a>))
      end
    end
    doc.to_html
  end
end


ActionView::Template.register_template_handler(:md, MarkdownHandler.new)